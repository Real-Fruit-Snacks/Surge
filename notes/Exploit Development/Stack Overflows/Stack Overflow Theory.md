---
tags:
  - Advanced
  - Binary_Exploitation
  - Debugging
  - Exploitation
  - Foundational
  - Stack_Overflow
  - WinDbg
  - Windows
---

## Stack Buffer Overflow Theory
resources: [Aleph One - Smashing the Stack](http://phrack.org/issues/49/14.html)

> Stack buffer overflows occur when data written to a stack buffer exceeds its allocated size, overwriting adjacent memory including saved return addresses.

### Vulnerable Code Pattern [Knowledge]
> Classic stack overflow occurs with unsafe string functions.

```c
void vulnerable(char *input) {
    char buffer[256];
    strcpy(buffer, input);  // No bounds checking!
    // If input > 256 bytes, overflow occurs
}
```

### Stack Layout During Overflow [Knowledge]
> Understanding what gets overwritten and in what order.

```text
Before Overflow:
+------------------+
|    Arguments     |  Higher addresses
+------------------+
|  Return Address  |  <- Target for control
+------------------+
|    Saved EBP     |
+------------------+
|                  |
|  Local Buffer    |  <- Overflow starts here
|    (256 bytes)   |
|                  |
+------------------+  Lower addresses

After Overflow (with 300 bytes):
+------------------+
|    AAAAAAAAAA    |  Arguments overwritten
+------------------+
|    0x41414141    |  Return address overwritten
+------------------+
|    0x41414141    |  Saved EBP overwritten
+------------------+
|                  |
|  AAAAAAAAAAAAA   |  Buffer filled
|    (256 bytes)   |
|                  |
+------------------+
```

### Exploitation Goal [Knowledge]
> [!important] Overwrite the return address to redirect execution to attacker-controlled shellcode:
> 1. Determine exact offset to return address
> 2. Find location to store shellcode
> 3. Find address to redirect execution (JMP ESP gadget)
> 4. Construct payload: padding + return address + shellcode

### Memory Protections [Knowledge]
> [!warning] Modern Windows includes protections against exploitation:
> - **DEP (Data Execution Prevention)**: Prevents code execution from stack/heap
> - **ASLR (Address Space Layout Randomization)**: Randomizes module base addresses
> - **Stack Canaries (GS)**: Detects stack corruption before return
> - **SafeSEH**: Validates exception handlers
> - **CFG (Control Flow Guard)**: Validates indirect call targets

### Bypassing Protections [Knowledge]
> [!tip] Techniques to overcome memory protections:
> - **Non-ASLR modules**: Find modules compiled without /DYNAMICBASE
> - **ROP (Return Oriented Programming)**: Chain existing code gadgets to bypass DEP
> - **Information leaks**: Obtain runtime addresses to defeat ASLR
> - **Partial overwrites**: Overwrite only part of return address

### Exploit Development Workflow [Knowledge]
> [!info] Standard process for developing a stack overflow exploit:
> 1. Identify the crash (fuzzing or analysis)
> 2. Determine offset to EIP control
> 3. Identify bad characters
> 4. Find suitable return address
> 5. Generate and test shellcode
> 6. Finalize and test exploit

