---
tags:
  - Advanced
  - Binary_Exploitation
  - Exploitation
  - Windows
---

## x86 Architecture Fundamentals
resources: [Intel x86 Manual](https://www.intel.com/content/www/us/en/developer/articles/technical/intel-sdm.html)

> Understanding x86 architecture is essential for exploit development. Key concepts include memory layout, CPU registers, and calling conventions.

### Program Memory Layout
> [!info] Windows processes have a virtual memory layout with distinct regions:
> - **Code Segment (.text)**: Contains executable instructions, typically read-only
> - **Data Segment (.data)**: Initialized global and static variables
> - **BSS Segment (.bss)**: Uninitialized global and static variables
> - **Heap**: Dynamically allocated memory, grows toward higher addresses
> - **Stack**: Local variables and function call data, grows toward lower addresses

### The Stack [Knowledge]
> [!info] The stack is a LIFO (Last In, First Out) data structure used for function calls, local variables, and control flow:
> - **Stack Growth**: On x86, the stack grows from high addresses to low addresses
> - **PUSH Operation**: Decrements ESP, then writes value to [ESP]
> - **POP Operation**: Reads value from [ESP], then increments ESP

```nasm
; Stack operations
push eax        ; ESP = ESP - 4; [ESP] = EAX
pop ebx         ; EBX = [ESP]; ESP = ESP + 4
```

### CPU Registers [Knowledge]
> [!info] x86 has eight 32-bit general purpose registers plus special registers for control flow:
> - **EAX**: Accumulator, used for arithmetic and return values
> - **EBX**: Base register, general purpose
> - **ECX**: Counter register, used for loops
> - **EDX**: Data register, used for I/O and arithmetic
> - **ESI**: Source Index, used for string operations
> - **EDI**: Destination Index, used for string operations
> - **EBP**: Base Pointer, points to current stack frame base
> - **ESP**: Stack Pointer, points to top of stack
> - **EIP**: Instruction Pointer, address of next instruction to execute

### Register Subdivisions [Knowledge]
> 32-bit registers can be accessed as smaller portions.

> **EAX** (32-bit) contains **AX** (16-bit lower), which contains **AH** (8-bit high) and **AL** (8-bit low).

```text
|-------- EAX (32-bit) --------|
              |-- AX (16-bit) --|
              | AH   |   AL    |
```

### Calling Conventions [Knowledge]
> [!info] **cdecl** (C declaration) is the default for C programs on x86:
> - **Arguments**: Pushed onto stack right-to-left
> - **Return Value**: Stored in EAX
> - **Stack Cleanup**: Caller is responsible for cleaning the stack
> - **Preserved Registers**: EBX, ESI, EDI, EBP must be preserved by callee

```nasm
; Calling function(1, 2, 3) in cdecl
push 3          ; Third argument
push 2          ; Second argument
push 1          ; First argument
call function
add esp, 12     ; Caller cleans up (3 args * 4 bytes)
```

### stdcall Convention [Knowledge]
> Used by Windows API functions.

> **Arguments**: Pushed right-to-left (same as cdecl).
> **Stack Cleanup**: Callee cleans the stack before returning.

```nasm
; Calling WinAPI function
push arg3
push arg2
push arg1
call WinAPIFunction  ; Callee cleans stack with RET n
```

### Stack Frame Layout [Knowledge]
> When a function is called, a stack frame is created.

```text
High Address
+------------------+
|   Argument N     |  [EBP + 8 + (N-1)*4]
+------------------+
|   Argument 2     |  [EBP + 12]
+------------------+
|   Argument 1     |  [EBP + 8]
+------------------+
|  Return Address  |  [EBP + 4]
+------------------+
|    Saved EBP     |  [EBP]
+------------------+
|  Local Var 1     |  [EBP - 4]
+------------------+
|  Local Var 2     |  [EBP - 8]
+------------------+
Low Address (ESP)
```

### Function Prologue and Epilogue [Knowledge]
> Standard function setup and teardown.

```nasm
; Prologue - function entry
push ebp          ; Save caller's base pointer
mov ebp, esp      ; Set up new base pointer
sub esp, N        ; Allocate space for local variables

; ... function body ...

; Epilogue - function exit
mov esp, ebp      ; Deallocate local variables
pop ebp           ; Restore caller's base pointer
ret               ; Return to caller
```

### EFLAGS Register [Knowledge]
> [!info] Contains status and control flags:
> - **ZF (Zero Flag)**: Set if result is zero
> - **SF (Sign Flag)**: Set if result is negative
> - **CF (Carry Flag)**: Set if unsigned overflow occurred
> - **OF (Overflow Flag)**: Set if signed overflow occurred

