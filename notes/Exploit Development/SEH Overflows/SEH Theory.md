---
tags:
  - Advanced
  - Binary_Exploitation
  - Debugging
  - Exploitation
  - Foundational
  - SEH_Overflow
  - WinDbg
  - Windows
---

## Structured Exception Handling Theory
resources: [Microsoft SEH Documentation](https://learn.microsoft.com/en-us/cpp/cpp/structured-exception-handling-c-cpp)

> Windows Structured Exception Handling (SEH) provides a mechanism to handle hardware and software exceptions. SEH overwrites exploit this mechanism for code execution.

### SEH Overview [Knowledge]
> [!info] SEH allows programs to gracefully handle exceptions like access violations, divide by zero, etc:
> - **Exception**: An abnormal condition during execution
> - **Handler**: Code that responds to the exception
> - **SEH Chain**: Linked list of exception handlers on the stack

### SEH Chain Structure [Knowledge]
> Each SEH record contains two pointers stored on the stack.

```text
+------------------+
| Exception Handler|  <- Address of handler function
+------------------+
|   Next SEH Ptr   |  <- Pointer to next SEH record (nSEH)
+------------------+
```

### SEH Chain in Memory [Knowledge]
> Multiple handlers form a linked list.

```text
FS:[0] -> SEH Record 1 -> SEH Record 2 -> ... -> 0xFFFFFFFF
          [nSEH][Handler]  [nSEH][Handler]        (End marker)
```

### TEB and FS Segment [Knowledge]
> The Thread Environment Block contains pointer to SEH chain.

```text
FS:[0x00] = Pointer to current SEH record
FS:[0x18] = Pointer to TEB itself
```

### View SEH Chain in WinDbg
> Display the current exception handler chain.

```text
!exchain                    ; Show SEH chain
dt ntdll!_EXCEPTION_REGISTRATION_RECORD poi(fs:[0])
```

### Exception Handling Flow [Knowledge]
> [!info] What happens when an exception occurs:
> 1. CPU raises exception
> 2. OS walks SEH chain from FS:[0]
> 3. Each handler is called with exception info
> 4. Handler returns: continue execution, continue search, or nested exception
> 5. If no handler handles it, process terminates

### SEH Handler Function Prototype [Knowledge]
> Handler function receives specific parameters.

```c
EXCEPTION_DISPOSITION __cdecl handler(
    EXCEPTION_RECORD *ExceptionRecord,
    void *EstablisherFrame,      // Pointer to our SEH record
    CONTEXT *ContextRecord,
    void *DispatcherContext
);
```

### SafeSEH Protection [Knowledge]
> [!warning] Compiler-based protection validates handlers:
> - **SafeSEH**: List of valid handlers compiled into executable
> - **SEHOP**: SEH Overwrite Protection (validates chain integrity)
> - Handlers must be in SafeSEH table or in non-SafeSEH module

### SEH Validation Checks [Knowledge]
> [!info] Windows performs several validations before calling handler:
> 1. Handler must not be on the stack
> 2. Handler must be in executable memory
> 3. Handler must be in SafeSEH table (if module uses SafeSEH)
> 4. SEHOP validates chain structure and final handler

### Viewing SEH Chain Details
> Examine individual SEH records.

```text
dd poi(fs:[0])              ; First SEH record
dd poi(poi(fs:[0]))         ; Second SEH record (nSEH of first)
```

### End of Chain Marker [Knowledge]
> The final SEH record has nSEH = 0xFFFFFFFF.

```text
0xFFFFFFFF marks end of SEH chain
Final handler is typically ntdll!FinalExceptionHandler
```

