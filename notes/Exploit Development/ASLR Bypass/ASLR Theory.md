---
tags:
  - Advanced
  - Binary_Exploitation
  - Debugging
  - Exploitation
  - Foundational
  - WinDbg
  - Windows
---

## ASLR Theory
resources: [Microsoft ASLR](https://learn.microsoft.com/en-us/windows/security/threat-protection/overview-of-threat-mitigations-in-windows-10)

> **ASLR** (Address Space Layout Randomization) randomizes memory addresses to prevent reliable exploitation.

### ASLR Overview [Knowledge]
> [!info] How ASLR protects against exploitation:
> - **Randomized on boot**: DLL base addresses change each reboot
> - **Randomized per-process**: Heap, stack, PEB locations vary per process
> - **Effect**: Hardcoded addresses no longer reliable
> - **Limitation**: Limited entropy on 32-bit systems

### What ASLR Randomizes [Knowledge]
> Memory regions affected by ASLR.

```text
Randomized:
- Executable image base (if compiled with /DYNAMICBASE)
- DLL base addresses (if compiled with /DYNAMICBASE)
- Stack base address
- Heap base address
- PEB/TEB locations

Not Randomized:
- Modules without /DYNAMICBASE
- Some legacy system DLLs
- Memory at fixed addresses (rare)
```

### Check ASLR Status
> Determine if module has ASLR enabled.

```text
; In WinDbg
!mona modules                 ; Shows ASLR/Rebase column

; In IDA
Edit -> Segments -> Rebase program (check if rebased)

; PE Header check
dumpbin /headers <Module.dll> | findstr "DYNAMIC"
```

### Check Module ASLR with Mona
> List modules and their protection status using **mona.py**.

```text
!mona modules

; Output columns:
; Rebase | SafeSEH | ASLR | NXCompat | OS Dll | Module
; False    False     False   False     False    vulnapp.exe
```

> [!tip] Look for modules with **ASLR=False** for reliable gadgets.

### ASLR Entropy [Knowledge]
> Amount of randomization provided.

```text
Windows 32-bit:
- Image base: ~8 bits entropy (256 possible locations)
- Stack: ~14 bits entropy
- Heap: ~5 bits entropy

Windows 64-bit:
- Image base: ~17-19 bits entropy
- Stack: ~17 bits entropy
- Significantly harder to brute force
```

### ASLR Bypass Strategies [Knowledge]
> [!important] Techniques to defeat ASLR:
> - **Non-ASLR module**: Find loaded module without ASLR, use its addresses
> - **Information disclosure**: Leak memory address, calculate base
> - **Partial overwrite**: Overwrite only low bytes (not randomized)
> - **Brute force**: Feasible on 32-bit with low entropy (crash recovery needed)
> - **Heap spray**: Fill memory with payload, increase hit probability

### Find Non-ASLR Modules
> Identify modules without ASLR protection.

```text
!mona modules -cm aslr=false

; Common non-ASLR scenarios:
; - Legacy applications
; - Third-party DLLs
; - Older runtime libraries
```

### Information Disclosure Approach [Knowledge]
> Leak address to defeat ASLR.

```text
1. Find vulnerability that leaks memory contents
2. Leak pointer to known structure (e.g., vtable, return address)
3. Calculate module base from leaked address
4. Use calculated base for ROP gadgets
5. Execute exploit with correct addresses
```

### Partial Overwrite Technique [Knowledge]
> Exploit without knowing full address.

```text
; Low 16 bits of addresses are not randomized
; If overwriting return address:

Original return: 0x12345678
Partial overwrite: 0x????56AB

; Overwrites 0x5678 -> 0x56AB
; Only need to know offset within page
```

### High Entropy ASLR (Windows 8+) [Knowledge]
> [!info] Enhanced ASLR on modern Windows:
> - **Bottom-up randomization**: Affects VirtualAlloc, MapViewOfFile
> - **High entropy 64-bit**: 24 bits for images, 33 bits for stack
> - **Force ASLR**: Even non-ASLR binaries can be randomized

### Check Process Mitigations
> View ASLR settings for process.

```powershell
Get-ProcessMitigation -Name <Process>
Get-ProcessMitigation -System
```

### Combining with DEP Bypass [Knowledge]
> ASLR and DEP together require both bypasses.

```text
Scenario: DEP + ASLR enabled
1. Find information disclosure vulnerability
2. Leak module base address
3. Calculate ROP gadget addresses
4. Build ROP chain with correct addresses
5. Execute ROP to disable DEP
6. Jump to shellcode
```
