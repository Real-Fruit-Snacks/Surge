---
tags:
  - Advanced
  - Binary_Exploitation
  - Debugging
  - Exploitation
  - Foundational
  - ROP
  - WinDbg
  - Windows
---

## Data Execution Prevention Theory
resources: [Microsoft DEP Documentation](https://learn.microsoft.com/en-us/windows/win32/memory/data-execution-prevention)

> DEP prevents code execution from non-executable memory regions like stack and heap.

### DEP Overview [Knowledge]
> [!info] Hardware and software-enforced execution prevention:
> - **Hardware DEP (NX bit)**: CPU marks pages as non-executable
> - **Software DEP**: SafeSEH validation (not true execution prevention)
> - **Effect**: Shellcode on stack/heap causes access violation when executed

### DEP Modes [Knowledge]
> [!info] Windows DEP configuration options:
> - **OptIn**: DEP only for system processes and opted-in applications
> - **OptOut**: DEP for all processes except opted-out applications
> - **AlwaysOn**: DEP for all processes, no exceptions
> - **AlwaysOff**: DEP disabled (rare, requires boot flag)

### Check DEP Status
> Determine DEP configuration on system.

```cmd
wmic OS Get DataExecutionPrevention_SupportPolicy
```

> 0=AlwaysOff, 1=AlwaysOn, 2=OptIn, 3=OptOut

### Check Process DEP Status
> Verify if specific process has DEP enabled.

```text
0:000> !vprot esp               ; Check stack protection
0:000> !address esp             ; Detailed memory info
```

> Look for PAGE_EXECUTE_READWRITE (DEP off) vs PAGE_READWRITE (DEP on).

### Check Module DEP Compatibility
> See if module is compiled with DEP support.

```text
!mona modules                   ; Lists NXCompat status
```

### Windows Defender Exploit Guard [Knowledge]
> [!info] Enhanced exploit mitigations in Windows 10+:
> - **Arbitrary Code Guard (ACG)**: Prevents dynamic code generation
> - **Control Flow Guard (CFG)**: Validates indirect call targets
> - **Return Flow Guard (RFG)**: Protects return addresses (limited)

### Check Exploit Guard Settings
> View Exploit Guard configuration.

```powershell
Get-ProcessMitigation -Name <Process>
Get-ProcessMitigation -System
```

### DEP Bypass Strategies [Knowledge]
> [!important] Techniques to execute code with DEP enabled:
> - **ROP (Return Oriented Programming)**: Chain existing code gadgets
> - **VirtualAlloc**: Allocate executable memory, copy shellcode
> - **VirtualProtect**: Mark existing memory as executable
> - **WriteProcessMemory**: Write shellcode to executable region
> - **SetProcessDEPPolicy**: Disable DEP for process (older Windows)

### ROP Overview [Knowledge]
> Execute code by chaining return addresses to existing instructions.

```text
Traditional exploit:         ROP exploit:
[padding]                    [padding]
[shellcode addr]             [gadget1 addr]  ; pop eax; ret
[shellcode...]               [value for eax]
                             [gadget2 addr]  ; call eax
```

### Why ROP Works [Knowledge]
> [!tip] DEP doesn't prevent executing existing code:
> - **Executable modules**: DLLs contain legitimate code
> - **Gadgets**: Short instruction sequences ending in RET
> - **Chaining**: RET pops next address, continues chain
> - **Result**: Arbitrary computation using existing code

